<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bairro: Vila Nova</title>

  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin="">

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #fff;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: #0f172a;
    }

    #map {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      background: #fff;
    }

    .topbar {
      position: absolute;
      z-index: 1100;
      left: 10px;
      top: 10px;
      background: rgba(255,255,255,.95);
      padding: 8px 10px;
      border-radius: 10px;
      box-shadow: 0 12px 32px rgba(0,0,0,.15);
      border: 1px solid rgba(0,0,0,0.07);
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 6px 10px;
      background:#fff;
      border:1px solid #ccc;
      border-radius:8px;
      cursor:pointer;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
    }

    .bairroNome {
      font-weight:700;
      color:#0f172a;
    }

    .info-panel {
      position: absolute;
      z-index: 1200;
      right: 10px;
      top: 70px;
      max-width: 300px;
      width: 300px;
      background: rgba(255,255,255,0.98);
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 12px;
      box-shadow: 0 20px 48px rgba(0,0,0,.25);
      padding: 16px 18px;
      font-size: 13px;
      line-height: 1.5;
      color:#1e293b;
      transition: all 0.3s ease;
    }

    .info-title {
      font-size: 15px;
      font-weight:700;
      color:#0f172a;
      margin-bottom:10px;
      line-height:1.4;
      word-break: break-word;
    }

    .info-label {
      font-size:12px;
      font-weight:600;
      color:#111827;
      margin-bottom:3px;
      line-height:1.4;
    }

    .info-value {
      font-size:13px;
      color:#374151;
      line-height:1.5;
      word-break:break-word;
      white-space:normal;
    }

    .badge-acess {
      font-size:12px;
      font-weight:600;
      color:#065f46;
      background:#ecfdf5;
      border:1px solid #6ee7b7;
      border-radius:8px;
      padding:4px 8px;
      display:inline-block;
      white-space:nowrap;
    }

    .info-hint {
      font-size:12px;
      color:#6b7280;
      line-height:1.4;
      font-style:italic;
    }

    @media(max-width: 480px){
      .info-panel {
        width: calc(100% - 20px);
        right: 10px;
        left: 10px;
        top: auto;
        bottom: 10px;
        max-width: none;
      }
    }
  </style>
</head>
<body>

  <div id="map" aria-label="Mapa do bairro Vila Nova"></div>

  <div class="topbar">
    <div class="bairroNome">Bairro: Vila Nova</div>
    <button class="btn" onclick="window.location.href='index.html'">Voltar</button>
    <button class="btn" id="resetViewBtn">Resetar visão</button>
  </div>

  <div class="info-panel" id="infoPanel">
    <div class="info-title">Passe o mouse sobre um ponto</div>
    <div class="info-hint">Veja os detalhes do serviço.</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    // ============================
    // 1. URLs de dados
    // ============================
    const BAIRROS_URL =
      "https://geo.joinville.sc.gov.br/server/rest/services/Hosted/BAIRROS/FeatureServer/3/query?where=1%3D1&outFields=*&f=geojson";

    const CITY_URL =
      "https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-42-mun.json";

    // ============================
    // 2. Config bairro + serviços
    // ============================
    const NOME_BAIRRO_ALVO = "vila nova";

    const servicesBairro = [
      {
        tipo: "Saúde",
        nomeServico: "UBSF Vila Nova 1",
        endereco: "R. Arthur Hille, 241",
        telefone: "(47) 3435-3956",
        horario: "Seg-Sex: 07h às 19h",
        observacoes: "Unidade básica com atendimento odontológico e vacinação.",
        acessibilidade: "Sim",
        lat: -26.2806598,
        lng: -48.9433735
      },
      {
        tipo: "Saúde",
        nomeServico: "UBSF Vila Nova Central",
        endereco: "R. XV de Novembro, 8436",
        telefone: "(47) 3439-2201",
        horario: "Seg-Sex: 07h às 19h",
        observacoes: "Unidade básica com atendimento odontológico e vacinação.",
        acessibilidade: "Sim",
        lat: -26.2871338,
        lng: -48.9926934
      },
      {
        tipo: "Saúde",
        nomeServico: "UBSF Vila Nova Rural",
        endereco: "Estrada Blumenau S/N",
        telefone: "(47) 3130-1900",
        horario: "Seg-Sex: 08h às 17h",
        observacoes: "Unidade básica com vacinação.",
        acessibilidade: "Sim",
        lat: -26.3149573,
        lng: -48.9502728
      },
      {
        tipo: "Recreação",
        nomeServico: "SESC Vila Nova",
        endereco: "R. Alwin Pasold",
        telefone: "(47) 3434-6991",
        horario: "Seg-Sab: Atividades diurnas e noturnas.",
        observacoes: "Espaço de recreação, com aula cultural e esportivo.",
        acessibilidade: "Sim",
        lat: -26.2846854,
        lng: -48.9055259
      }
    ];

    // ============================
    // 3. Helpers
    // ============================
    function escapeHTML(str){
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function normalizeName(str){
      return String(str || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"")
        .toLowerCase()
        .trim();
    }

    function renderInfoPanel(svc){
      const panel = document.getElementById('infoPanel');
      panel.innerHTML = `
        <div class="info-title">${escapeHTML(svc.nomeServico)}</div>

        <div class="info-label">Tipo de Serviço</div>
        <div class="info-value">${escapeHTML(svc.tipo)}</div>

        <div class="info-label">Endereço</div>
        <div class="info-value">${escapeHTML(svc.endereco)}</div>

        <div class="info-label">Telefone</div>
        <div class="info-value">${escapeHTML(svc.telefone)}</div>

        <div class="info-label">Horário de Atendimento</div>
        <div class="info-value">${escapeHTML(svc.horario)}</div>

        <div class="info-label">Descrição / Observações</div>
        <div class="info-value">${escapeHTML(svc.observacoes)}</div>

        <div class="badge-acess">Acessibilidade: ${escapeHTML(svc.acessibilidade)}</div>
      `;
    }

    function resetInfoPanel(){
      const panel = document.getElementById('infoPanel');
      panel.innerHTML = `
        <div class="info-title">Passe o mouse sobre um ponto</div>
        <div class="info-hint">Veja os detalhes do serviço.</div>
      `;
    }

    // ============================
    // 4. Mapa
    // ============================
    document.addEventListener('DOMContentLoaded', () => {
      const map = L.map('map');

      let combinedBounds = null; // bounds geral (Joinville + pins)

      // 4.1 Primeiro: carregar Joinville (limite municipal)
      fetch(CITY_URL)
        .then(r => r.json())
        .then(cityData => {
          // filtrar só Joinville
          const feats = (cityData.features || []).filter(f => {
            const p = f.properties || {};
            const n = String(
              p.name || p.NM_MUNICIP || p.NM_MUN || p.nome || ""
            ).toLowerCase();
            return n === "joinville";
          });

          if (!feats.length) {
            console.warn("Não encontrei Joinville no CITY_URL");
            return;
          }

          const cityLayer = L.geoJSON(
            { type:"FeatureCollection", features: feats },
            {
              style: {
                color:"#94a3b8",    // cinza-azulado leve
                weight:2,
                fillOpacity:0
              }
            }
          ).addTo(map);

          // inicia o bounds combinado com Joinville
          combinedBounds = cityLayer.getBounds();

          // depois que desenhei Joinville, carrego o bairro e os pontos
          carregarBairroEservicos();
        });

      function carregarBairroEservicos(){
        fetch(BAIRROS_URL)
          .then(r => r.json())
          .then(gj => {
            const onlyThisBairro = {
              type: "FeatureCollection",
              features: (gj.features || []).filter(f => {
                const props = f.properties || {};
                const rawName = props.nome_bairr || props.NOME || props.name || "";
                const norm = normalizeName(rawName);
                return norm.startsWith(NOME_BAIRRO_ALVO);
              })
            };

            if (!onlyThisBairro.features.length){
              alert("Bairro não encontrado no mapa oficial (nome pode estar diferente).");
              console.warn("Nenhuma feature encontrada para", NOME_BAIRRO_ALVO, onlyThisBairro);
              return;
            }

            // desenha só o bairro alvo
            const bairroLayer = L.geoJSON(onlyThisBairro, {
              style: {
                color: "#1e293b",
                weight: 3,
                fillColor: "#60a5fa",
                fillOpacity: 0.25
              }
            }).addTo(map);

            // amplia o bounds combinado para incluir o polígono do bairro
            combinedBounds.extend(bairroLayer.getBounds());

            // ícone dos serviços
            const pinIcon = L.icon({
              iconUrl:
                'data:image/svg+xml;utf8,' +
                encodeURIComponent(`
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none">
                    <path d="M16 2C10.2 2 5.5 6.7 5.5 12.5c0 2.9 1.2 5.1 2.8 7.3 1.7 2.1 3.8 4.1 5.5 6.2.8 1 1.6 2 2.2 3 .6-1 1.4-2 2.2-3 1.7-2.1 3.8-4.1 5.5-6.2 1.6-2.2 2.8-4.4 2.8-7.3C26.5 6.7 21.8 2 16 2z" fill="#2563eb"/>
                    <circle cx="16" cy="12" r="4.5" fill="white"/>
                  </svg>
                `),
              iconSize: [32, 32],
              iconAnchor: [16, 32]
            });

            // criar marcador pra cada serviço
            servicesBairro.forEach(svc => {
              const ll = L.latLng(svc.lat, svc.lng);
              const marker = L.marker(ll, { icon: pinIcon }).addTo(map);

              marker.on('mouseover', () => {
                renderInfoPanel(svc);
              });
              marker.on('mouseout', () => {
                resetInfoPanel();
              });

              // bounds agora também inclui cada serviço
              combinedBounds.extend(ll);
            });

            // enquadrar tudo:
            map.fitBounds(combinedBounds, { padding:[30,30] });

            // reset visão usa esse bounds global
            document.getElementById('resetViewBtn').addEventListener('click', () => {
              if (combinedBounds && combinedBounds.isValid()) {
                map.fitBounds(combinedBounds, { padding:[30,30] });
              }
            });
          })
          .catch(err => {
            console.error("Erro carregando bairro:", err);
            alert("Erro ao carregar dados do bairro.");
          });
      }
    });
  </script>
</body>
</html>